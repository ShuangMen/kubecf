{{ define "scripts_destroy_gke" }}
{{- /* destroy gke cluster and pvc */}}

# Login to gcloud
printf "%s" '((gke-suse-cap-json))' > $PWD/gke-key.json
gcloud auth activate-service-account --key-file $PWD/gke-key.json
export GKE_PROJECT="{{ .gke_project }}"
export GKE_CLUSTER_ZONE="{{ .gke_zone }}"
export GKE_DNS_ZONE="{{ .gke_dns_zone }}"
export GKE_CLUSTER_NAME="kubecf-ci-${BRANCH}-${CFSCHEDULER}-$(cat semver.gke-cluster/version | sed 's/\./-/g')"
export GKE_DOMAIN="{{ .gke_domain }}"
export DOMAIN="${GKE_CLUSTER_NAME}.${GKE_DOMAIN}"

# Get a kubeconfig
gcloud container clusters get-credentials ${GKE_CLUSTER_NAME} --zone ${GKE_CLUSTER_ZONE} --project "${GKE_PROJECT}"

pvcs=$(kubectl get pvc -n scf -o json | jq -r .items[].spec.volumeName | paste -sd "|")
tcp_router_ip=$(kubectl get svc -n scf tcp-router-public -o json | jq -r .status.loadBalancer.ingress[].ip | head -n 1)
public_router_ip=$(kubectl get svc -n scf router-public -o json | jq -r .status.loadBalancer.ingress[].ip | head -n 1)

# Delete cluster
gcloud --quiet container --project "${GKE_PROJECT}" clusters delete "${GKE_CLUSTER_NAME}" \
      --zone "${GKE_CLUSTER_ZONE}"

# Delete leftover disks assigned to (now deleted) pvcs.
# https://cloud.google.com/compute/docs/instances/preemptible#understanding_the_preemption_process
# https://groups.google.com/d/msg/gce-discussion/RLrwOx8fazo/9ve7lIdsBQAJ
DISK_IDS=$(gcloud compute disks list \
      --filter="zone~${GKE_CLUSTER_ZONE}" \
      --filter="name~${pvcs}" \
      --filter="-users:*" \
      --format="value(id)" \
      --project=${GKE_PROJECT})

# Delete pvc disks associated to the cluster, now that they are free
for ID in ${DISK_IDS}; do
    gcloud compute disks delete ${ID} --zone=${GKE_CLUSTER_ZONE} \
                                      --project="${GKE_PROJECT}" --quiet;
done

gcloud --quiet beta dns --project=${GKE_PROJECT} record-sets \
  transaction start --zone=${GKE_DNS_ZONE}
gcloud --quiet beta dns --project=${GKE_PROJECT} record-sets \
  transaction remove --name=\*.${DOMAIN}. --ttl=300 --type=A \
  --zone=${GKE_DNS_ZONE} $public_router_ip
gcloud --quiet beta dns --project=${GKE_PROJECT} record-sets \
  transaction remove --name=tcp.${DOMAIN}. --ttl=300 --type=A \
  --zone=${GKE_DNS_ZONE} $tcp_router_ip
gcloud --quiet beta dns --project=${GKE_PROJECT} record-sets \
  transaction execute --zone=${GKE_DNS_ZONE}

{{ end }}
